name: Sync MegafonNew UUIDs Stable

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests

      - name: Update UUIDs and set flag
        id: upd_script_step
        run: |
          python3 - << 'EOF' > script_output.txt
import re, requests, sys
import os

SOURCE_URL = "s3c3.001.gpucloud.ru"
TARGET = "test.txt"
CHANGES_DETECTED = "false"

try:
    src = requests.get(SOURCE_URL, timeout=10).text
except:
    print("changes=false")
    sys.exit(0)

m = re.search(r"vless://([a-f0-9-]+)@[^\\s#]+#.*MegafonNew", src, re.I)
if not m:
    print("changes=false")
    sys.exit(0)

uuid = m.group(1)

with open(TARGET, "r", encoding="utf-8") as f:
    text = f.read()

new_text = re.sub(
    r"(vless://)[a-f0-9-]+(@[^\\s#]+#.*MegafonNew)",
    r"\\1" + uuid + r"\\2",
    text,
    flags=re.I
)

if new_text != text:
    with open(TARGET, "w", encoding="utf-8") as f:
        f.write(new_text)
    CHANGES_DETECTED = "true"

print(f"changes={CHANGES_DETECTED}")
EOF
          # Извлекаем флаг из вывода скрипта и сохраняем его в переменную среды GitHub Actions
          CHANGES=$(grep "changes=" script_output.txt | cut -d'=' -f2)
          echo "COMMIT_NEEDED=$CHANGES" >> $GITHUB_ENV
          cat script_output.txt

      - name: Commit update
        # Используем переменную среды GITHUB_ENV для проверки условия
        if: env.COMMIT_NEEDED == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Megafon UUID updated"
          files: test.txt
