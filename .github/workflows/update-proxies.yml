name: Sync MegafonNew UUIDs

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install requests
        run: pip install requests

      - name: Check & update UUIDs
        id: updater
        run: |
          cat > sync.py << 'EOF'
import re
import requests
import os

SOURCE_URL = "https://s3c3.001.gpucloud.ru/timestar1/love"
TARGET_FILE = "test.txt"

# загрузка исходника
try:
    src = requests.get(SOURCE_URL, timeout=10).text
except Exception as e:
    print("ERROR fetching source:", e)
    print("changes=false")
    exit(1)

# найти все URL с MegafonNew
matches = re.findall(r"(vless://[a-f0-9\\-]+@[^\s#]+)#.*?MegafonNew[^\s]+", src)
if not matches:
    print("No MegafonNew entries found in source")
    print("changes=false")
    exit(0)

# например, берём первый
first_url = matches[0]
print("First matching URL:", first_url)

# из URL извлечь UUID (часть до @)
m2 = re.match(r"vless://([a-f0-9\\-]+)@", first_url)
if not m2:
    print("Could not extract UUID")
    print("changes=false")
    exit(0)
new_uuid = m2.group(1)
print("New UUID:", new_uuid)

# читаем твой файл
with open(TARGET_FILE, "r", encoding="utf-8") as f:
    content = f.read()

# заменяем все URL’ы с MegafonNew на новый UUID
updated = re.sub(r"(vless://)[a-f0-9\\-]+(@[^\s#]+#.*?MegafonNew[^\s]+)", r"\1"+new_uuid+r"\2", content)

if updated != content:
    with open(TARGET_FILE, "w", encoding="utf-8") as f:
        f.write(updated)
    print("changes=true")
else:
    print("changes=false")
EOF
          python3 sync.py | tee out.log
          CHG=$(grep -m1 "changes=" out.log | cut -d= = -f2)
          echo "changes_detected=$CHG" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.updater.outputs.changes_detected == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Sync MegafonNew UUIDs"
          file_pattern: test.txt
