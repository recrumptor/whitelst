name: Update VLESS UUID Proxies

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-proxies-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run proxy update script
        id: update
        run: |
          python3 << 'EOF'
import requests
import re
from urllib.parse import urlparse, urlunparse

SOURCE_URL = "https://s3c3.001.gpucloud.ru/timestar1/love"
TARGET_FILE_PATH = "test.txt"

# Твой список прокси:
TARGET_PROXIES_LIST = [
    # (обрезал ради краткости — вставь весь список)
]

def extract_uuid(vless_url):
    parsed = urlparse(vless_url)
    return parsed.username

def update_uuid_in_url(vless_url, new_uuid):
    parsed = urlparse(vless_url)
    new_netloc = f"{new_uuid}@{parsed.hostname}:{parsed.port}"
    return urlunparse(parsed._replace(netloc=new_netloc))

def main():
    try:
        resp = requests.get(SOURCE_URL, timeout=10)
        resp.raise_for_status()
        text = resp.text
    except Exception as e:
        print(f"Ошибка загрузки источника: {e}")
        print("CHANGES_DETECTED=false")
        return

    match = re.search(r"vless://([a-f0-9-]+)@", text)
    if not match:
        print("UUID не найден в источнике.")
        print("CHANGES_DETECTED=false")
        return

    new_uuid = match.group(1)
    print(f"Получен UUID: {new_uuid}")

    changed = False
    new_list = []

    for url in TARGET_PROXIES_LIST:
        old_uuid = extract_uuid(url)
        if old_uuid != new_uuid:
            changed = True
            new_list.append(update_uuid_in_url(url, new_uuid))
        else:
            new_list.append(url)

    if changed:
        with open(TARGET_FILE_PATH, "w", encoding="utf-8") as f:
            for line in new_list:
                f.write(line + "\n")
        print("CHANGES_DETECTED=true")
    else:
        print("CHANGES_DETECTED=false")

if __name__ == "__main__":
    main()
EOF

          # перенаправляем флаг в GITHUB_OUTPUT
          CHANGES=$(grep "CHANGES_DETECTED=" -m1 <(python3 - <<'EOF'
import sys
# Это просто чтобы избежать запуска второго раза — мы не запускаем код здесь.
EOF
))
          echo "changes_detected=$(grep 'CHANGES_DETECTED=' script_output.txt | cut -d= -f2)" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.update.outputs.changes_detected == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Автоматическое обновление UUID прокси"
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"
          file_pattern: test.txt
