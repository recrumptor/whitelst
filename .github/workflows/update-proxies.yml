name: Update VLESS UUID Proxies

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-proxies-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install requests
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run update script
        id: updater
        run: |
          # создаём python-скрипт (корректно для YAML — используется обычный pipe)
          cat > update_proxies.py <<'PY'
import requests
import re
from urllib.parse import urlparse, urlunparse

SOURCE_URL = "https://s3c3.001.gpucloud.ru/timestar1/love"
TARGET_FILE_PATH = "test.txt"

# <<< ВСТАВЬ СЮДА СВОЙ СПИСОК ПРОКСИ (строки в кавычках, запятые) >>>
TARGET_PROXIES_LIST = [
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.105.64:9443?security=reality#example1",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@84.201.138.55:8443?security=reality#example2"
]

def extract_uuid(vless_url):
    parsed = urlparse(vless_url)
    return parsed.username

def update_uuid_in_url(vless_url, new_uuid):
    parsed = urlparse(vless_url)
    # собираем новый netloc: uuid@host:port
    host = parsed.hostname or ""
    port = parsed.port or ""
    new_netloc = f"{new_uuid}@{host}:{port}" if port else f"{new_uuid}@{host}"
    return urlunparse(parsed._replace(netloc=new_netloc))

def main():
    try:
        r = requests.get(SOURCE_URL, timeout=15)
        r.raise_for_status()
        content = r.text
    except Exception as e:
        print("ERROR: failed to fetch source:", e)
        print("CHANGES_DETECTED=false")
        return

    m = re.search(r"vless://([a-f0-9-]+)@", content)
    if not m:
        print("CHANGES_DETECTED=false")
        return

    new_uuid = m.group(1)
    changed = False
    updated = []
    for url in TARGET_PROXIES_LIST:
        old = extract_uuid(url)
        if old != new_uuid:
            updated.append(update_uuid_in_url(url, new_uuid))
            changed = True
        else:
            updated.append(url)

    if changed:
        with open(TARGET_FILE_PATH, "w", encoding="utf-8") as f:
            for line in updated:
                f.write(line + "\\n")
        print("CHANGES_DETECTED=true")
    else:
        print("CHANGES_DETECTED=false")

if __name__ == '__main__':
    main()
PY

          # запускаем и сохраняем вывод
          python3 update_proxies.py | tee action_output.log
          # передаём флаг в GITHUB_OUTPUT корректным способом
          CHG=$(grep -m1 "CHANGES_DETECTED=" action_output.log | cut -d= -f2 || echo "false")
          echo "changes_detected=$CHG" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.updater.outputs.changes_detected == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto update UUID in proxies"
          file_pattern: test.txt
