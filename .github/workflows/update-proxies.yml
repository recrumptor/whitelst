name: Update VLESS UUID Proxies

on:
  push:
    branches:
      - main # Запускать при каждом пуше в ветку main (или master)
  schedule:
    # Запускать каждый день в 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Разрешает запуск вручную через интерфейс GitHub Actions

jobs:
  update-proxies-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run proxy update script
        id: run_script_step
        shell: bash
        run: |
          # Встроенный Python-скрипт для проверки и обновления прокси
          python <<EOF > script_output.txt
import requests
import re
import os
from urllib.parse import urlparse, urlunparse

# ИСПРАВЛЕННЫЙ URL ИСТОЧНИКА
SOURCE_URL = "https://s3c3.001.gpucloud.ru/timestar1/love"
TARGET_FILE_PATH = "test.txt"

# Список ваших целевых прокси, которые нужно обновлять
TARGET_PROXIES_LIST = [
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.99.49:4249?security=reality&type=tcp&headerType=none&path=&host=&flow=xtls-rprx-vision&sni=api-maps.yandex.ru&fp=qq&pbk=-P63w9lGjUCrsgtWlR7qvHGpy93mJSspIvwfXSuVixA&sid=a20d3ed244c76426#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%AA%F0%9F%87%AA%D0%AD%D1%81%D1%82%D0%BE%D0%BD%D0%B8%D1%8F%28MegafonNew-19%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.105.64:9443?security=reality&type=xhttp&headerType=&path=%2F&host=&mode=auto&sni=api-maps.yandex.ru&fp=qq&pbk=J5ITJbg5FQFembAfkogKHHQB6DigsFXQxK7xu-QMWUs&sid=a20d3ed244c76426#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%B3%F0%9F%87%B1%D0%9D%D0%B8%D0%B4%D0%B5%D1%80%D0%BB%D0%B0%D0%BD%D0%B4%D1%8B%28MegafonNew-11%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@84.201.138.55:8443?security=reality&type=grpc&headerType=&authority=&serviceName=grpc&mode=gun&sni=api-maps.yandex.ru&fp=qq&pbk=J5ITJbg5FQFembAfkogKHHQB6DigsFXQxK7xu-QMWUs&sid=6b2f4e6ac9b1d2f0#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%B7%F0%9F%87%BA%D0%A1%D0%B0%D0%BD%D0%BA%D1%82-%D0%9F%D0%B5%D1%82%D0%B5%D1%80%D0%B1%D1%83%D1%80%D0%B3%28MegafonNew-6%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@84.201.161.178:4249?security=reality&type=tcp&headerType=none&path=&host=&flow=xtls-rprx-vision&sni=api-maps.yandex.ru&fp=qq&pbk=koPEXma6Cn65z3Rka3DCtp-UPwmAFFs9Wii9M4ewxBI&sid=a20d3ed244c76426#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%B1%F0%9F%87%BB%D0%9B%D0%B0%D1%82%D0%B2%D0%B8%D1%8F%28MegafonNew-15%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.104.227:4249?security=reality&type=tcp&headerType=none&path=&host=&flow=xtls-rprx-vision&sni=api-maps.yandex.ru&fp=qq&pbk=uWicR5hgESYN55kBb5OQhaounsEkhPKsLZDU0sNKcEQ&sid=a20d3ed244c76426#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%B3%F0%9F%87%B1%D0%9D%D0%B8%D0%B4%D0%B5%D1%80%D0%BB%D0%B0%D0%BD%D0%B4%D1%8B%28MegafonNew-18%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.27.132:7443?security=reality&type=tcp&headerType=none&path=&host=&flow=xtls-rprx-vision&sni=api-maps.yandex.ru&fp=qq&pbk=J5ITJbg5FQFembAfkogKHHQB6DigsFXQxK7xu-QMWUs&sid=a20d3ed244c76426#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%A9%F0%9F%87%AA%D0%93%D0%B5%D1%80%D0%BC%D0%B0%D0%BD%D0%B8%D1%8F%28MegafonNew-7%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.21.113:7443?security=reality&type=tcp&headerType=none&path=&host=&flow=xtls-rprx-vision&sni=api-maps.yandex.ru&fp=qq&pbk=J5ITJbg5FQFembAfkogKHHQB6DigsFXQxK7xu-QMWUs&sid=a20d3ed244c76426#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%B5%F0%9F%87%B1%D0%9F%D0%BE%D0%BB%D1%8C%D1%88%D0%B0%28MegafonNew%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.21.113:8443?security=reality&type=grpc&headerType=&authority=&serviceName=grpc&mode=gun&sni=api-maps.yandex.ru&fp=chrome&pbk=J5ITJbg5FQFembAfkogKHHQB6DigsFXQxK7xu-QMWUs&sid=6b2f4e6ac9b1d2f0#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%B5%F0%9F%87%B1%D0%9F%D0%BE%D0%BB%D1%8C%D1%88%D0%B0%28MegafonNew-3%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.27.132:8443?security=reality&type=grpc&headerType=&authority=&serviceName=grpc&mode=gun&sni=api-maps.yandex.ru&fp=qq&pbk=J5ITJbg5FQFembAfkogKHHQB6DigsFXQxK7xu-QMWUs&sid=6b2f4e6ac9b1d2f0#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%A9%F0%9F%87%AA%D0%93%D0%B5%D1%80%D0%BC%D0%B0%D0%BD%D0%B8%D1%8F%28MegafonNew-9%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.21.113:8090?security=reality&type=xhttp&headerType=&path=%2F&host=&mode=auto&sni=api-maps.yandex.ru&fp=qq&pbk=J5ITJbg5FQFembAfkogKHHQB6DigsFXQxK7xu-QMWUs&sid=a20d3ed244c76426#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%B5%F0%9F%87%B1%D0%9F%D0%BE%D0%BB%D1%8C%D1%88%D0%B0%28MegafonNew-2%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.105.64:7443?security=reality&type=tcp&headerType=none&path=&host=&flow=xtls-rprx-vision&sni=api-maps.yandex.ru&fp=qq&pbk=J5ITJbg5FQFembAfkogKHHQB6DigsFXQxK7xu-QMWUs&sid=a20d3ed244c76426#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%B3%F0%9F%87%B1%D0%9D%D0%B8%D0%B4%D0%B5%D1%80%D0%BB%D0%B0%D0%BD%D0%B4%D1%8B%28MegafonNew-10%F0%9F%9F%A2%29",
    "vless://703fd847-9154-428f-aaa3-6c596813458e@51.250.27.132:8090?security=reality&type=xhttp&headerType=&path=%2F&host=&mode=auto&sni=api-maps.yandex.ru&fp=qq&pbk=J5ITJbg5FQFembAfkogKHHQB6DigsFXQxK7xu-QMWUs&sid=a20d3ed244c76426#%F0%9F%92%8ECIDR%F0%9F%92%8E%F0%9F%87%A9%F0%9F%87%AA%D0%93%D0%B5%D1%80%D0%BC%D0%B0%D0%BD%D0%B8%D1%8F%28MegafonNew-8%F0%9F%9F%A2%29"
]

def extract_uuid(vless_url):
    try:
        parsed = urlparse(vless_url)
        uuid = parsed.username
        return uuid
    except Exception:
        return None

def update_uuid_in_url(vless_url, new_uuid):
    try:
        parsed = urlparse(vless_url)
        new_netloc = f"{new_uuid}@{parsed.hostname}:{parsed.port}"
        new_url = urlunparse(parsed._replace(netloc=new_netloc))
        return new_url
    except Exception:
        return vless_url

def check_and_update_proxies():
    try:
        response = requests.get(SOURCE_URL)
        response.raise_for_status()
        source_content = response.text
    except requests.exceptions.RequestException as e:
        print(f"Не удалось загрузить исходный список прокси: {e}")
        exit(1) 

    uuid_match = re.search(r"vless://([a-f0-9-]+)@", source_content)
    if not uuid_match:
        print("Актуальный UUID в исходном списке не найден.")
        exit(1)

    actual_uuid = uuid_match.group(1)
    # print(f"Найден актуальный UUID: {actual_uuid}") # Закомментировано для безопасности
    print(f"Актуальный UUID найден.")

    updated_proxies = []
    changes_made = False
    for proxy_url in TARGET_PROXIES_LIST:
        current_uuid = extract_uuid(proxy_url)
        if current_uuid and current_uuid != actual_uuid:
            new_proxy_url = update_uuid_in_url(proxy_url, actual_uuid)
            updated_proxies.append(new_proxy_url)
            changes_made = True
            # print(f"Обновлен прокси (старый UUID: {current_uuid[:8]}..., новый: {actual_uuid[:8]}...)")
        else:
            updated_proxies.append(proxy_url)

    if changes_made:
        print("Ключ изменился. Запись обновленных прокси в файл test.txt")
        with open(TARGET_FILE_PATH, "w", encoding="utf-8") as f:
            for line in updated_proxies:
                f.write(line + "\n")
        print(f"CHANGES_DETECTED=true")
    else:
        print("Ключ не изменился. Обновление не требуется.")
        print(f"CHANGES_DETECTED=false")

if __name__ == "__main__":
    check_and_update_proxies()
EOF
          # Извлекаем флаг CHANGES_DETECTED из вывода скрипта для использования в следующем шаге
          CHANGES=$(grep "CHANGES_DETECTED=" script_output.txt | cut -d'=' -f2)
          echo "::set-output name=changes_detected::$CHANGES"
          # Также выводим содержимое script_output.txt в лог Actions для отладки
          cat script_output.txt

      - name: Commit and push changes
        if: steps.run_script_step.outputs.changes_detected == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Автоматическое обновление UUID прокси
          token: ${{ secrets.GITHUB_TOKEN }}
          files: test.txt
