name: Filter Vless Links for Timeweb Only

on:
  workflow_dispatch:
  # Можно запускать вручную или по расписанию

permissions:
  contents: write

jobs:
  filter:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Filter file using grep and compare
        id: filter_step
        run: |
          set -e

          # Определяем имя файла
          TARGET_FILE="my_vless_links.txt"
          FILTER_KEYWORD="Timeweb"
          
          # Убедитесь, что файл существует
          if [ ! -f "$TARGET_FILE" ]; then
            echo "Файл $TARGET_FILE не найден. Создаем пустой файл для начала."
            touch "$TARGET_FILE"
            # Если файла не было, то и изменений после фильтрации не будет при первом запуске
            echo "changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Фильтруем файл $TARGET_FILE, оставляя только строки с '$FILTER_KEYWORD'..."

          # 1. Делаем временную копию исходного файла для сравнения изменений
          cp "$TARGET_FILE" "$TARGET_FILE.bak"

          # 2. Используем grep для фильтрации и перезаписываем оригинальный файл
          # Оставляем только строки, начинающиеся с vless:// и содержащие Timeweb
          grep -E -i '^vless://.*'"$FILTER_KEYWORD"'.*' "$TARGET_FILE.bak" > "$TARGET_FILE"

          # 3. Проверяем, были ли изменения в файле
          if cmp -s "$TARGET_FILE.bak" "$TARGET_FILE"; then
            echo "Изменений в файле нет."
            echo "changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Изменения внесены. Файл обновлен."
            echo "changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit update
        # Запускаем коммит только если были изменения
        if: steps.filter_step.outputs.changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Filter links: Keep Timeweb only"
          # !!! ИСПРАВЛЕНИЕ: указываем имя файла напрямую !!!
          file_pattern: "my_vless_links.txt" 
