name: Deduplicate mytimeweb.txt (Ignore description)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deduplicate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Remove duplicate lines by ignoring the # description
        id: deduplicate_step
        run: |
          set -e

          TARGET_FILE="mytimeweb.txt"
          
          if [ ! -f "$TARGET_FILE" ]; then
            echo "Файл $TARGET_FILE не найден!"
            echo "changes=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "Начинаем поиск и удаление дубликатов, игнорируя описание после '#'..."

          cp "$TARGET_FILE" "$TARGET_FILE.bak"

          # Используем AWK:
          # $0 - вся строка
          # sub(/#.*/, "", clean_line) - удаляем все, что начинается с # в строке clean_line
          # !seen[clean_line]++ - проверяем уникальность по очищенной строке
          # 1 - выводим строку, если она уникальна
          awk '
            {
              clean_line = $0;
              sub(/#.*/, "", clean_line);
              if (!seen[clean_line]++) {
                print $0;
              }
            }
          ' "$TARGET_FILE.bak" > "$TARGET_FILE"

          # Проверяем, были ли изменения
          if cmp -s "$TARGET_FILE.bak" "$TARGET_FILE"; then
            echo "Дубликатов не найдено. Изменений нет."
            echo "changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Дубликаты удалены. Файл обновлен."
            echo "changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit update
        if: steps.deduplicate_step.outputs.changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Fix: Remove duplicate Vless links (ignoring description)"
          file_pattern: "mytimeweb.txt"
